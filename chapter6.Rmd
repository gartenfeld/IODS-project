# Week 6 Longitudinal Analysis

*This week we follow through the examples in Exercise Set 6.*

```{r}
date()
```

## Analysis

Read in the transformed datasets:

```{r}
library(readr)
BPRS <- read_csv("data/BPRS_long.csv", show_col_types = FALSE)
RATS <- read_csv("data/RATS_long.csv", show_col_types = FALSE)
```

### Part A

> "Implement the analyses of Chapter 8 of MABS ... but using the RATS data"

> "Look at the (column) names"

```{r}
names(RATS)
```

> "Look at the structure"

```{r}
str(RATS)
```

> "Print out summaries of the variables"

```{r}
summary(RATS)
```

> Convert categorical columns to factor

```{r}
RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)
```

> "Take a glimpse at the data"

```{r}
library(dplyr)
glimpse(RATS)
```

> "Draw the plot"

```{r}
library(ggplot2)
rat_count <- length(unique(RATS$ID))
colour_palette <- sample(rainbow(rat_count))
range <- c(min(RATS$Weight), max(RATS$Weight))
ggplot(RATS, aes(x = Time, y = Weight)) +
#  geom_smooth(aes(color = ID), method = "loess", se = FALSE) +
  geom_line(aes(color = ID)) +
  scale_color_manual(values = colour_palette) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = range)
```

> "Standardise the variable"

```{r}
Standardised_RATS <- RATS %>%
  group_by(Time) %>%
  mutate(Standardised_Weight = (Weight - mean(Weight))/sd(Weight)) %>%
  ungroup()
```

> "Glimpse the data"

```{r}
glimpse(Standardised_RATS)
```

> "Plot again with the standardised values"

```{r}
library(ggplot2)
rat_count <- length(unique(Standardised_RATS$ID))
colour_palette <- sample(rainbow(rat_count))
range <- c(min(Standardised_RATS$Standardised_Weight), max(Standardised_RATS$Standardised_Weight))
ggplot(Standardised_RATS, aes(x = Time, y = Standardised_Weight)) +
  geom_line(aes(color = ID)) +
  scale_color_manual(values = colour_palette) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = range, name = "Standardised Weight")
```

> Summarise data with mean and standard error of Weight by Group and Time"

```{r}
Summarised_RATS <- RATS %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = sd(Weight) / sqrt(length(Weight)) ) %>%
  ungroup()
```

> "Glimpse the data"

```{r}
glimpse(Summarised_RATS)
```

> "Plot the mean profiles"

```{r}
ggplot(Summarised_RATS, aes(x = Time, y = mean)) +
  geom_line(aes(color = Group)) +
  geom_ribbon(aes(ymin = mean - se, ymax = mean + se, fill = Group), alpha = 0.2) +
  scale_y_continuous(name = "Weight")
```

> Check for outliers

> "Create summary data by Group and ID with mean as the summary variable

```{r}
RATS_box <- RATS %>%
  filter(Time > 0) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()
```

> "Glimpse the data"

```{r}
glimpse(RATS_box)
```

> "Draw a boxplot of the mean"

```{r}
ggplot(RATS_box, aes(x = Group, y = mean, fill = Group)) +
  geom_boxplot(alpha = 0.2, width = 0.2) +
  scale_y_continuous(name = "Mean Weight")
```

Comments: there is a fat rat in Group 2 but it's not all that extreme.

Try a filtered plot anyway:

```{r}
Group_2_filtered <- RATS_box %>%
  filter(mean < 550, Group == 2)

ggplot(Group_2_filtered, aes(y = mean, x = Group)) +
  geom_boxplot(width = 0.1) +
  scale_y_continuous(name = "Mean Weight")
```

> "Perform a two-sample t-test"

```{r}
# Since the rats fall into 3 groups, let's try testing only the first two
rats_1_2 <- subset(RATS_box, Group %in% c(1, 2))
t.test(mean ~ Group, data = rats_1_2, var.equal = TRUE)
```

This reiterates what's visible from the box plot, Group 1 & 2 are very different

Check Group 2 & 3, which are closer to each other:

```{r}
rats_2_3 <- subset(RATS_box, Group %in% c(2, 3))
t.test(mean ~ Group, data = rats_2_3, var.equal = TRUE)
```

Due to the low number of rats in each group, we can't be sure they are materially different.

Add a baseline column for the starting weight

```{r}
RATS_wide <- read_csv("data/RATS_wide.csv", show_col_types = FALSE)
RATS_based <- RATS_box %>%
  mutate(baseline = RATS_wide$WD1)
```

> "Fit a model"

```{r}
fit <- lm(mean ~ baseline + Group, data = RATS_based)
summary(fit)
```

> "Compute the ANnalysis Of VAriance table for the fitted model"

```{r}
anova(fit)
```

Here the results are a bit baffling, baseline is highly significant, meaning that the rat's starting weight explains its future weight.

Whereas, the diet is just about above the 0.05 threshold for significant, in over-generalised summary: diet doesn't matter.

For future research, perhaps the relative gains in weight could be modelled, which, I guess, was pretty much what the original Part II in the exercise set with random intercepts method was about.

#### Interpretations: Part A

Even though the empirical evidence and analysis and plots pretty much tell the story already, I will nonetheless repeat it here with words so as to satisfy the requirements of having interpretations.



### Part B

> "Implement the analyses of Chapter 9 of MABS ... but using the BPRS data"

> "Factor variables"

```{r}
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
```

> "Glimpse the data"

```{r}
glimpse(BPRS)
```
> "Check the dimensions of the data"

```{r}
dim(BPRS)
```

> "Plot the data"

```{r}
ggplot(BPRS, aes(x = week, y = bprs, group = subject)) +
  geom_line(aes(col = subject), alpha = 0.5) +
  facet_grid(. ~ treatment, labeller = label_both) +
  scale_x_continuous(name = "Week") + 
  scale_y_continuous(name = "Score") +
  theme(legend.position = "none")
```

> "Create a regression model"

```{r}
BPRS_regression_model <- lm(bprs ~ week + treatment, data = BPRS)
summary(BPRS_regression_model)
```

Intercept is like the starting point, the `week` has an estimate of -2.27, meaning score decreases by 2 points per week.

Being in a different treatment group doesn't seem to do much (p = 0.661).

> "Create a random intercept model"

```{r}
library(lme4)
BPRS_RI_model <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRS, REML = FALSE)
summary(BPRS_RI_model)
```

> "Create a random intercept and random slope model"

```{r}
BPRS_RI_RS_model <- lmer(bprs ~ week + treatment + (week | subject), data = BPRS, REML = FALSE)
summary(BPRS_RI_RS_model)
```

> "Perform an ANOVA test on the two models"

```{r}
anova(BPRS_RI_RS_model, BPRS_RI_model)
```

Comments: Including a random slope within subjects significantly improves the model fit compared to a model with only a random intercept.


> "Create a random intercept and random slope model with the interaction"

```{r}
BPRS_interaction <- lmer(bprs ~ week * treatment + (week | subject), data = BPRS, REML = FALSE)
summary(BPRS_interaction)
```

Compare new best to old best:

```{r}
anova(BPRS_interaction, BPRS_RI_RS_model)
```

Nah, not better enough.

> "Create a vector of the fitted values"

```{r}
Fitted <- fitted(BPRS_interaction)
```

> "Create a new column `fitted`"

```{r}
BPRS_fitted <- mutate(BPRS, Fitted = Fitted)
```

> "Draw the plot with the Fitted scores"

```{r}
library(ggplot2)
ggplot(BPRS_fitted, aes(x = week, y = Fitted, group = subject)) +
  geom_line(aes(col = subject)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  scale_x_continuous(name = "Week") +
  scale_y_continuous(name = "Fitted BPRS") +
  theme(legend.position = "none")
```

So many models, it's a spaghetti plot.

#### Interpretations: Part B
